import argparse
import sys

from odplib import preso


def rename_style(t_file, fromto):
    from_, to_ = fromto.split(':')
    t = preso.Template(t_file)
    page_names = t.get_master_page_names()
    if from_ not in page_names:
        raise Exception("{} not found in styles: {}".format(to_, str(page_names)))
    # update all references
    style_xml = t.styles
    ns = preso.ns
    attrs = [ns('style', 'name'), ns('style', 'parent-style-name'),
             ns('presentation', 'style-name')]
    #import pdb; pdb.set_trace()
    for node in style_xml.iter():
        for n in attrs:
            val = node.get(n)
            if val and val.startswith(from_):
                #import pdb; pdb.set_trace()
                new_val = val.replace(from_, to_)
                print val, new_val
                node.set(n, new_val)
    t.styles = style_xml
    t.zipfile.touch('styles.xml', preso.to_xml(style_xml))
    t.to_file(t_file)





def main(args):
    parser = argparse.ArgumentParser()
    parser.add_argument('-t', help='template file')
    parser.add_argument('--rename-style', help="old:new")

    args = parser.parse_args(args)
    if args.rename_style:
        rename_style(args.t, args.rename_style)

if __name__ == '__main__':
    main(sys.argv[1:])
